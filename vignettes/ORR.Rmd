---
title: "ORR Guideline Suggestions"
author: "Alexis COCHARD"
date: "2025-02-17"
output: 
  rmarkdown::html_vignette:
    number_sections: true
vignette: >
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteIndexEntry{Kaplan-Meier Guideline Suggestions}
  %\VignetteEncoding{UTF-8}
---

# Introduction

This vignette illustrates the implementation of ORR analysis in R using `flextable` package. 
In this example, the following response-based endpoints are analysed:

*Objective Response Rate (ORR), unconfirmed and confirmed:
Estimated separately for single-arm and two-arm studies, measuring the proportion of patients achieving a complete or partial response to treatment within a specified time frame.A partial response is a decrease in the size of a tumor or in the amount of cancer in the body, and a complete response is the disappearance of all signs of cancer in the body. In a clinical trial, measuring the ORR is one way to see how well a new treatment works.

*Clinical Benefit Rate (CBR):
Calculated using two different methods, typically incorporating complete response, partial response, and stable disease to assess overall treatment benefit.

This vignette covers the following steps:

-   Preparation of the dataset.

-   Overall Response Rate (ORR) unconfirmed with 1 arm studies and 2 arms studies

-   Overall Response Rate (ORR) confirmed with 1 arm studies and 2 arm studies

-   The Clinical Benefit Rate (CBR), with 2 different methods to calculate it

Each of those steps will be followed by a given example of results using the `flextable` package

First, install packages if needed and load them.

```{r setup, warning=FALSE, message=FALSE}
## Load libraries

library(grstat)
library(officer)
library(GenBinomApps)
library(flextable)
library(tidyverse)
```

# Data Preparation

## Data Overview

To calculate the ORR, we'll use the “recist” dataset.
This dataset must be in long format (one line represents a single measure of a patient's recist criterion) and must contain at least the columns :
 
-   subjid, Patient ID

-   rcdt, Evaluation date

-   rcresp, Global response


## Display dataset

In the case of a study with several arms, a column defining the inclusion arm (here arm) is also required.

```{r}
db <- grstat_example(N=200, rc_coef_treatement = 3)
recist <- db$recist
arm <- db$enrolres[c("subjid", "arm")]
recist = recist %>%
  left_join(arm, join_by("subjid"))
colnames(recist) <- tolower(colnames(recist))
head(recist)

dim(recist)
```


# Overall Response Rate (ORR) unconfirmed

An unconfirmed response is defined as :

-   Obtain the best response per patients during study time

## Clinical Trial with only 1 arm

```{r}
recist_2=recist %>% 
  arrange(as.numeric(subjid), rcdt) %>% 
  distinct(subjid,rcresp, rcdt) %>%
  mutate(rcresp_num=as.factor(rcresp),
         rcresp_num=as.numeric(rcresp_num)
  ) %>% 
  filter(!is.na(rcresp_num)) %>%
  mutate(previous_rcresp_num=lag(rcresp_num),
         previous_date=lag(rcdt),
         delta_date=as.numeric(rcdt - previous_date),
         delta_date= ifelse(is.na(delta_date),0,delta_date),
         delta_date_before_PD_or_end = cumsum(delta_date),
         bestresponse_withinprotocole=ifelse(previous_rcresp_num==rcresp_num, 1, 0 ),
         .by = subjid
  )

unconfirmed_best_response=recist_2 %>% 
  mutate(bestresponse=min(rcresp_num),
         .by = subjid
  ) %>% 
  filter(bestresponse==rcresp_num) %>% 
  slice_head(by=subjid) 


#Example of result without using the flextable package
table(unconfirmed_best_response$rcresp)
```

We can also do a few checks to see if all patients are included, or to modify to “Not evaluable” patients for whom data-management problems have been detected.

```{r}
#Exemple : patient 129 should be "Not evaluable"
final_unconfirmed_best_response<- unconfirmed_best_response
final_unconfirmed_best_response$rcresp[final_unconfirmed_best_response$subjid == 129]<- "Not evaluable"
```

Now, we will create the Overall_ORR : 

-   Overall_ORR corresponds to a partial response (PR) or a complete response (CR)

```{r}
final_unconfirmed_best_response= final_unconfirmed_best_response %>%
  mutate(Overall_ORR= ifelse(rcresp=="Complete response" | rcresp=="Partial response",1,0))
```

Finally, we will use the `flextable` package for a table of results

```{r}
total <- length(unique(final_unconfirmed_best_response$subjid))
CR_unconfirmed <- length(final_unconfirmed_best_response$rcresp[final_unconfirmed_best_response$rcresp == "Complete response"])
PR_unconfirmed <- length(final_unconfirmed_best_response$rcresp[final_unconfirmed_best_response$rcresp == "Partial response"])
SD_unconfirmed <- length(final_unconfirmed_best_response$rcresp[final_unconfirmed_best_response$rcresp == "Stable disease"])
PD_unconfirmed <- length(final_unconfirmed_best_response$rcresp[final_unconfirmed_best_response$rcresp == "Progressive disease"])
NE_unconfirmed <- length(final_unconfirmed_best_response$rcresp[final_unconfirmed_best_response$rcresp == "Not evaluable"])
Overall_ORR_unconfirmed <- CR_unconfirmed + PR_unconfirmed

CR_unconfirmed_CP <- clopper.pearson.ci(CR_unconfirmed,total,CI="two.sided", alpha = 0.05)
PR_unconfirmed_CP <- clopper.pearson.ci(PR_unconfirmed,total,CI="two.sided", alpha = 0.05)
SD_unconfirmed_CP <- clopper.pearson.ci(SD_unconfirmed,total,CI="two.sided", alpha = 0.05)
PD_unconfirmed_CP <- clopper.pearson.ci(PD_unconfirmed,total,CI="two.sided", alpha = 0.05)
NE_unconfirmed_CP <- clopper.pearson.ci(NE_unconfirmed,total,CI="two.sided", alpha = 0.05)
Overall_ORR_unconfirmed_CP <- clopper.pearson.ci(Overall_ORR_unconfirmed,total,CI="two.sided", alpha = 0.05)

CR_unconfirmed_CP_IC <- paste0("[",round(CR_unconfirmed_CP$Lower.limit*100,1),";",round(CR_unconfirmed_CP$Upper.limit*100,1),"]")
PR_unconfirmed_CP_IC <- paste0("[",round(PR_unconfirmed_CP$Lower.limit*100,1),";",round(PR_unconfirmed_CP$Upper.limit*100,1),"]")
SD_unconfirmed_CP_IC <- paste0("[",round(SD_unconfirmed_CP$Lower.limit*100,1),";",round(SD_unconfirmed_CP$Upper.limit*100,1),"]")
PD_unconfirmed_CP_IC <- paste0("[",round(PD_unconfirmed_CP$Lower.limit*100,1),";",round(PD_unconfirmed_CP$Upper.limit*100,1),"]")
NE_unconfirmed_CP_IC <- paste0("[",round(NE_unconfirmed_CP$Lower.limit*100,1),";",round(NE_unconfirmed_CP$Upper.limit*100,1),"]")
Overall_ORR_unconfirmed_CP_IC <- paste0("[",round(Overall_ORR_unconfirmed_CP$Lower.limit*100,1),";",round(Overall_ORR_unconfirmed_CP$Upper.limit*100,1),"]")

IC_95_unconfirmed <- c(Overall_ORR_unconfirmed_CP_IC,
                       CR_unconfirmed_CP_IC,
                       PR_unconfirmed_CP_IC,
                       SD_unconfirmed_CP_IC,
                       PD_unconfirmed_CP_IC,
                       NE_unconfirmed_CP_IC)

Name <- c("Overall ORR",
          "Complete response (CR)",
          "Partial response (PR)",
          "Stable disease (SD)",
          "Progressive disease (PD)",
          "Non evaluable (NE)")

N_unconfirmed <- c(Overall_ORR_unconfirmed,
                   CR_unconfirmed,
                   PR_unconfirmed,
                   SD_unconfirmed,
                   PD_unconfirmed,
                   NE_unconfirmed)

Percentage_unconfirmed <- c(round(Overall_ORR_unconfirmed/total*100,1),
                            round(CR_unconfirmed/total*100,1),
                            round(PR_unconfirmed/total*100,1),
                            round(SD_unconfirmed/total*100,1),
                            round(PD_unconfirmed/total*100,1),
                            round(NE_unconfirmed/total*100,1))

unconfirmed_Best_Response_during_treatment <- as.data.frame(cbind(Name,N_unconfirmed,Percentage_unconfirmed,IC_95_unconfirmed))
colnames(unconfirmed_Best_Response_during_treatment) <- c("Unconfirmed Best Response during treatment",paste0("N=",total),"%","IC 95%")
unconfirmed_Best_Response_during_treatment =  unconfirmed_Best_Response_during_treatment %>%
  as_flextable(show_coltype = F, include.row_percent = FALSE, include.column_percent = FALSE, include.table_percent = FALSE) %>%
  delete_rows(i=1, part = "footer") %>%
  bold(i = 1, j = 1, bold = TRUE, part = "body") %>%
  bold(bold = TRUE, part = "header") %>%
  surround(i = 1, j = 1:4, border.bottom = fp_border(color = "black", style = "solid", width = 1), part = "body")  %>%
  footnote( i = 1, j = 4,
            value = as_paragraph(
              c("Clopper-Pearson (Exact) method was used for confidence interval")),
            ref_symbols ="*", part = "header") %>%
  valign(valign = "bottom", part = "header") %>%
  footnote( i = 6, j = 1,
            value = as_paragraph(
              c("Example : Patient 129 had NE as her global response for target lesion was NE.")),
            ref_symbols = c("1"), part = "body") %>%
  valign(valign = "bottom", part = "header")

unconfirmed_Best_Response_during_treatment
```

## Clinical Trial with 2 arms

Objectives are the same clinical studies with only 1 arm, we will just add a separation between the 2 arms in the flextable

```{r}
recist_2=recist %>% 
  arrange(as.numeric(subjid), rcdt) %>% 
  distinct(subjid,rcresp, rcdt,arm) %>%
  mutate(rcresp_num=as.factor(rcresp),
         rcresp_num=as.numeric(rcresp_num)
  ) %>% 
  filter(!is.na(rcresp_num)) %>%
  mutate(previous_rcresp_num=lag(rcresp_num),
         previous_date=lag(rcdt),
         delta_date=as.numeric(rcdt - previous_date),
         delta_date= ifelse(is.na(delta_date),0,delta_date),
         delta_date_before_PD_or_end = cumsum(delta_date),
         bestresponse_withinprotocole=ifelse(previous_rcresp_num==rcresp_num, 1, 0 ),
         .by = subjid
  )

unconfirmed_best_response_2_arm=recist_2 %>% 
  mutate(bestresponse=min(rcresp_num),
         .by = subjid
  ) %>% 
  filter(bestresponse==rcresp_num) %>% 
  slice_head(by=subjid) 

table(unconfirmed_best_response_2_arm$rcresp, unconfirmed_best_response_2_arm$arm)


#Exemple : patient 129 should be "Not evaluable"

final_unconfirmed_best_response_2_arm<- unconfirmed_best_response_2_arm
final_unconfirmed_best_response_2_arm$rcresp[final_unconfirmed_best_response_2_arm$subjid == 129]<- "Not evaluable"

final_unconfirmed_best_response_2_arm= final_unconfirmed_best_response_2_arm %>%
  mutate(Overall_ORR= ifelse(rcresp=="Complete response" | rcresp=="Partial response",1,0))


treatment <-final_unconfirmed_best_response_2_arm %>% 
  filter(arm=="Treatment")

control <-final_unconfirmed_best_response_2_arm %>% 
  filter(arm=="Control")


#Since we have 2 arms, we will first creae the part of the control

total_control <- length(unique(control$subjid))
CR_unconfirmed_control <- length(control$rcresp[control$rcresp == "Complete response"])
PR_unconfirmed_control <- length(control$rcresp[control$rcresp == "Partial response"])
SD_unconfirmed_control <- length(control$rcresp[control$rcresp == "Stable disease"])
PD_unconfirmed_control <- length(control$rcresp[control$rcresp == "Progressive disease"])
NE_unconfirmed_control <- length(control$rcresp[control$rcresp == "Not evaluable"])
Overall_ORR_unconfirmed_control <- CR_unconfirmed_control + PR_unconfirmed_control

CR_unconfirmed_CP_control <- clopper.pearson.ci(CR_unconfirmed_control,total_control,CI="two.sided", alpha = 0.05)
PR_unconfirmed_CP_control <- clopper.pearson.ci(PR_unconfirmed_control,total_control,CI="two.sided", alpha = 0.05)
SD_unconfirmed_CP_control <- clopper.pearson.ci(SD_unconfirmed_control,total_control,CI="two.sided", alpha = 0.05)
PD_unconfirmed_CP_control <- clopper.pearson.ci(PD_unconfirmed_control,total_control,CI="two.sided", alpha = 0.05)
NE_unconfirmed_CP_control <- clopper.pearson.ci(NE_unconfirmed_control,total_control,CI="two.sided", alpha = 0.05)
Overall_ORR_unconfirmed_CP_control <- clopper.pearson.ci(Overall_ORR_unconfirmed_control,total_control,CI="two.sided", alpha = 0.05)

CR_unconfirmed_CP_IC_control <- paste0("[",round(CR_unconfirmed_CP_control$Lower.limit*100,1),";",round(CR_unconfirmed_CP_control$Upper.limit*100,1),"]")
PR_unconfirmed_CP_IC_control <- paste0("[",round(PR_unconfirmed_CP_control$Lower.limit*100,1),";",round(PR_unconfirmed_CP_control$Upper.limit*100,1),"]")
SD_unconfirmed_CP_IC_control <- paste0("[",round(SD_unconfirmed_CP_control$Lower.limit*100,1),";",round(SD_unconfirmed_CP_control$Upper.limit*100,1),"]")
PD_unconfirmed_CP_IC_control <- paste0("[",round(PD_unconfirmed_CP_control$Lower.limit*100,1),";",round(PD_unconfirmed_CP_control$Upper.limit*100,1),"]")
NE_unconfirmed_CP_IC_control <- paste0("[",round(NE_unconfirmed_CP_control$Lower.limit*100,1),";",round(NE_unconfirmed_CP_control$Upper.limit*100,1),"]")
Overall_ORR_unconfirmed_CP_IC_control <- paste0("[",round(Overall_ORR_unconfirmed_CP_control$Lower.limit*100,1),";",round(Overall_ORR_unconfirmed_CP_control$Upper.limit*100,1),"]")

IC_95_unconfirmed_control <- c(Overall_ORR_unconfirmed_CP_IC_control,
                       CR_unconfirmed_CP_IC_control,
                       PR_unconfirmed_CP_IC_control,
                       SD_unconfirmed_CP_IC_control,
                       PD_unconfirmed_CP_IC_control,
                       NE_unconfirmed_CP_IC_control)

Name <- c("Overall ORR",
          "Complete response (CR)",
          "Partial response (PR)",
          "Stable disease (SD)",
          "Progressive disease (PD)",
          "Non evaluable (NE)")

N_unconfirmed_control <- c(Overall_ORR_unconfirmed_control,
                   CR_unconfirmed_control,
                   PR_unconfirmed_control,
                   SD_unconfirmed_control,
                   PD_unconfirmed_control,
                   NE_unconfirmed_control)

Percentage_unconfirmed_control <- c(round(Overall_ORR_unconfirmed_control/total_control*100,1),
                            round(CR_unconfirmed_control/total_control*100,1),
                            round(PR_unconfirmed_control/total_control*100,1),
                            round(SD_unconfirmed_control/total_control*100,1),
                            round(PD_unconfirmed_control/total_control*100,1),
                            round(NE_unconfirmed_control/total_control*100,1))

#Then we create the part of the treatment

total_treatment <- length(unique(treatment$subjid))
CR_unconfirmed_treatment <- length(treatment$rcresp[treatment$rcresp == "Complete response"])
PR_unconfirmed_treatment <- length(treatment$rcresp[treatment$rcresp == "Partial response"])
SD_unconfirmed_treatment <- length(treatment$rcresp[treatment$rcresp == "Stable disease"])
PD_unconfirmed_treatment <- length(treatment$rcresp[treatment$rcresp == "Progressive disease"])
NE_unconfirmed_treatment <- length(treatment$rcresp[treatment$rcresp == "Not evaluable"])
Overall_ORR_unconfirmed_treatment <- CR_unconfirmed_treatment + PR_unconfirmed_treatment

CR_unconfirmed_CP_treatment <- clopper.pearson.ci(CR_unconfirmed_treatment,total_treatment,CI="two.sided", alpha = 0.05)
PR_unconfirmed_CP_treatment <- clopper.pearson.ci(PR_unconfirmed_treatment,total_treatment,CI="two.sided", alpha = 0.05)
SD_unconfirmed_CP_treatment <- clopper.pearson.ci(SD_unconfirmed_treatment,total_treatment,CI="two.sided", alpha = 0.05)
PD_unconfirmed_CP_treatment <- clopper.pearson.ci(PD_unconfirmed_treatment,total_treatment,CI="two.sided", alpha = 0.05)
NE_unconfirmed_CP_treatment <- clopper.pearson.ci(NE_unconfirmed_treatment,total_treatment,CI="two.sided", alpha = 0.05)
Overall_ORR_unconfirmed_CP_treatment <- clopper.pearson.ci(Overall_ORR_unconfirmed_treatment,total_treatment,CI="two.sided", alpha = 0.05)


CR_unconfirmed_CP_IC_treatment <- paste0("[",round(CR_unconfirmed_CP_treatment$Lower.limit*100,1),";",round(CR_unconfirmed_CP_treatment$Upper.limit*100,1),"]")
PR_unconfirmed_CP_IC_treatment <- paste0("[",round(PR_unconfirmed_CP_treatment$Lower.limit*100,1),";",round(PR_unconfirmed_CP_treatment$Upper.limit*100,1),"]")
SD_unconfirmed_CP_IC_treatment <- paste0("[",round(SD_unconfirmed_CP_treatment$Lower.limit*100,1),";",round(SD_unconfirmed_CP_treatment$Upper.limit*100,1),"]")
PD_unconfirmed_CP_IC_treatment <- paste0("[",round(PD_unconfirmed_CP_treatment$Lower.limit*100,1),";",round(PD_unconfirmed_CP_treatment$Upper.limit*100,1),"]")
NE_unconfirmed_CP_IC_treatment <- paste0("[",round(NE_unconfirmed_CP_treatment$Lower.limit*100,1),";",round(NE_unconfirmed_CP_treatment$Upper.limit*100,1),"]")
Overall_ORR_unconfirmed_CP_IC_treatment <- paste0("[",round(Overall_ORR_unconfirmed_CP_treatment$Lower.limit*100,1),";",round(Overall_ORR_unconfirmed_CP_treatment$Upper.limit*100,1),"]")

IC_95_unconfirmed_treatment <- c(Overall_ORR_unconfirmed_CP_IC_treatment,
                       CR_unconfirmed_CP_IC_treatment,
                       PR_unconfirmed_CP_IC_treatment,
                       SD_unconfirmed_CP_IC_treatment,
                       PD_unconfirmed_CP_IC_treatment,
                       NE_unconfirmed_CP_IC_treatment)

Name <- c("Overall ORR",
          "Complete response (CR)",
          "Partial response (PR)",
          "Stable disease (SD)",
          "Progressive disease (PD)",
          "Non evaluable (NE)")

N_unconfirmed_treatment <- c(Overall_ORR_unconfirmed_treatment,
                   CR_unconfirmed_treatment,
                   PR_unconfirmed_treatment,
                   SD_unconfirmed_treatment,
                   PD_unconfirmed_treatment,
                   NE_unconfirmed_treatment)

Percentage_unconfirmed_treatment <- c(round(Overall_ORR_unconfirmed_treatment/total_treatment*100,1),
                            round(CR_unconfirmed_treatment/total_treatment*100,1),
                            round(PR_unconfirmed_treatment/total_treatment*100,1),
                            round(SD_unconfirmed_treatment/total_treatment*100,1),
                            round(PD_unconfirmed_treatment/total_treatment*100,1),
                            round(NE_unconfirmed_treatment/total_treatment*100,1))

#Finnaly we merge the 2 arms

unconfirmed_Best_Response_during_treatment_2_arms <- as.data.frame(cbind(Name,
                                                                         N_unconfirmed_control,
                                                                         Percentage_unconfirmed_control,
                                                                         IC_95_unconfirmed_control,
                                                                         N_unconfirmed_treatment,
                                                                         Percentage_unconfirmed_treatment,
                                                                         IC_95_unconfirmed_treatment))
colnames(unconfirmed_Best_Response_during_treatment_2_arms) <- c("Unconfirmed Best Response during treatmen",
                                                                 paste0("Control_N=",total_control),
                                                                 "Control_%",
                                                                 "Control_IC 95%",
                                                                 paste0("Treatment_N=",total_treatment),
                                                                 "Treatment_%",
                                                                 "Treatment_IC 95%")
unconfirmed_Best_Response_during_treatment_2_arms =  unconfirmed_Best_Response_during_treatment_2_arms %>%
  as_flextable(show_coltype = F, include.row_percent = FALSE, include.column_percent = FALSE, include.table_percent = FALSE) %>%
  delete_rows(i=1, part = "footer") %>%
  separate_header() %>% 
  align(align = "center", part = "header") %>%
  align(align = "center", part = "body") %>%
  bold(bold = TRUE, part = "header") %>%
  bold(i = 1, j = 1, bold = TRUE, part = "body") %>%
  surround(i = 1, j = 1:7, border.bottom = fp_border(color = "black", style = "solid", width = 1), part = "body")  %>%
  footnote( i = 2, j = c(4,7),
            value = as_paragraph(
              c("Clopper-Pearson (Exact) method was used for confidence interval")),
            ref_symbols ="*", part = "header") %>%
  valign(valign = "bottom", part = "header") %>%
  footnote( i = 6, j = 1,
            value = as_paragraph(
              c("Example : Patient 129 had NE as her global response for target lesion was NE.")),
            ref_symbols = c("1"), part = "body") %>%
  valign(valign = "bottom", part = "header") %>%
  vline(j = c(1,4), border = fp_border(color = "black", style = "solid", width = 2)) %>%
  autofit()
unconfirmed_Best_Response_during_treatment_2_arms
```


# Overall Response Rate (ORR) confirmed

Now that we have results for unconfirmed ORR, we will look at confirmed ORR.
The confirmation is defined in the recist guideline  DOI: 10.1016/j.ejca.2008.10.026 

## Clinical Trial with only 1 arm

```{r}
recist_2=recist %>% 
  arrange(as.numeric(subjid), rcdt) %>% 
  distinct(subjid,rcresp, rcdt) %>%
  mutate(rcresp_num=as.factor(rcresp),
         rcresp_num=as.numeric(rcresp_num)
  ) %>% 
  filter(!is.na(rcresp_num)) %>%
  mutate(previous_rcresp_num=lag(rcresp_num),
         previous_date=lag(rcdt),
         delta_date=as.numeric(rcdt - previous_date),
         delta_date= ifelse(is.na(delta_date),0,delta_date),
         delta_date_before_PD_or_end = cumsum(delta_date),
         bestresponse_withinprotocole=ifelse(previous_rcresp_num==rcresp_num, 1, 0 ),
         .by = subjid
  )
```

Following the recist guideline, here's how to get a confirmed result

```{r}
recist_2$meilleur_reponse <- recist_2$rcresp_num

recist_2$meilleur_reponse[recist_2$rcresp_num == 1 & 
                             recist_2$previous_rcresp_num == 1 &
                             recist_2$delta_date >= 28] <- 1
recist_2$meilleur_reponse[recist_2$rcresp_num == 1 & 
                             recist_2$previous_rcresp_num == 1 &
                             recist_2$delta_date < 28] <- 3
recist_2$meilleur_reponse[recist_2$rcresp_num == 1 & 
                             recist_2$previous_rcresp_num == 2 &
                             recist_2$delta_date >= 28] <- 2
recist_2$meilleur_reponse[recist_2$rcresp_num == 1 & 
                             recist_2$previous_rcresp_num == 2 &
                             recist_2$delta_date < 28] <- 3
recist_2$meilleur_reponse[recist_2$rcresp_num == 1 & 
                             recist_2$previous_rcresp_num == 3] <- 3
recist_2$meilleur_reponse[recist_2$rcresp_num == 1 & 
                             recist_2$previous_rcresp_num == 4] <- 4
recist_2$meilleur_reponse[recist_2$rcresp_num == 1 & 
                             recist_2$previous_rcresp_num == 5] <- 5

recist_2$meilleur_reponse[recist_2$rcresp_num == 2 & 
                             recist_2$previous_rcresp_num <=2 &
                             recist_2$delta_date >= 28] <- 2
recist_2$meilleur_reponse[recist_2$rcresp_num == 2 & 
                             recist_2$previous_rcresp_num <= 2 &
                             recist_2$delta_date < 28] <- 3
recist_2$meilleur_reponse[recist_2$rcresp_num == 2 & 
                             recist_2$previous_rcresp_num == 3] <- 3
recist_2$meilleur_reponse[recist_2$rcresp_num == 2 & 
                             recist_2$previous_rcresp_num == 4] <- 4
recist_2$meilleur_reponse[recist_2$rcresp_num == 2 & 
                             recist_2$previous_rcresp_num == 5] <- 5

recist_2$meilleur_reponse[is.na(recist_2$previous_rcresp_num) & recist_2$rcresp_num==4] <- 4

final_confirmed_best_response=recist_2 %>% 
  mutate(bestresponse=min(meilleur_reponse),
         .by=subjid
  ) %>% 
  filter(bestresponse==meilleur_reponse) %>% 
  slice_head(by=subjid)
```


We can also do a few checks to see if all patients are included, or to modify to “Not evaluable” patients for whom data-management problems have been detected.

```{r}
#Exemple : patient 129 should be "Not evaluable"

final_confirmed_best_response$rcresp[final_confirmed_best_response$subjid == 129]<- "Not evaluable"
```

Now, we will create the Overall_ORR : 

-   Overall_ORR corresponds to a partial response (PR) or a complete response (CR)

```{r}
#Enfin on ajoute les colonnes qui nous permettrons de savoir si le patient est TRUE ou FALSE pour overall_ORR
final_confirmed_best_response= final_confirmed_best_response %>%
  mutate(Overall_ORR= ifelse(rcresp=="Complete response" | rcresp=="Partial response",1,0))
```

Finally, we will use the `flextable` package for a table of results

```{r}
total <- length(unique(final_confirmed_best_response$subjid))
CR_confirmed <- length(final_confirmed_best_response$rcresp[final_confirmed_best_response$rcresp == "Complete response"])
PR_confirmed <- length(final_confirmed_best_response$rcresp[final_confirmed_best_response$rcresp == "Partial response"])
SD_confirmed <- length(final_confirmed_best_response$rcresp[final_confirmed_best_response$rcresp == "Stable disease"])
PD_confirmed <- length(final_confirmed_best_response$rcresp[final_confirmed_best_response$rcresp == "Progressive disease"])
NE_confirmed <- length(final_confirmed_best_response$rcresp[final_confirmed_best_response$rcresp == "Not evaluable"])
Overall_ORR_confirmed <- length(final_confirmed_best_response$Overall_ORR[final_confirmed_best_response$Overall_ORR==1])

CR_confirmed_CP <- clopper.pearson.ci(CR_confirmed,total,CI="two.sided", alpha = 0.05)
PR_confirmed_CP <- clopper.pearson.ci(PR_confirmed,total,CI="two.sided", alpha = 0.05)
SD_confirmed_CP <- clopper.pearson.ci(SD_confirmed,total,CI="two.sided", alpha = 0.05)
PD_confirmed_CP <- clopper.pearson.ci(PD_confirmed,total,CI="two.sided", alpha = 0.05)
NE_confirmed_CP <- clopper.pearson.ci(NE_confirmed,total,CI="two.sided", alpha = 0.05)
Overall_ORR_confirmed_CP <- clopper.pearson.ci(Overall_ORR_confirmed,total,CI="two.sided", alpha = 0.05)

CR_confirmed_CP_IC <- paste0("[",round(CR_confirmed_CP$Lower.limit*100,1),";",round(CR_confirmed_CP$Upper.limit*100,1),"]")
PR_confirmed_CP_IC <- paste0("[",round(PR_confirmed_CP$Lower.limit*100,1),";",round(PR_confirmed_CP$Upper.limit*100,1),"]")
SD_confirmed_CP_IC <- paste0("[",round(SD_confirmed_CP$Lower.limit*100,1),";",round(SD_confirmed_CP$Upper.limit*100,1),"]")
PD_confirmed_CP_IC <- paste0("[",round(PD_confirmed_CP$Lower.limit*100,1),";",round(PD_confirmed_CP$Upper.limit*100,1),"]")
NE_confirmed_CP_IC <- paste0("[",round(NE_confirmed_CP$Lower.limit*100,1),";",round(NE_confirmed_CP$Upper.limit*100,1),"]")
Overall_ORR_confirmed_CP_IC <- paste0("[",round(Overall_ORR_confirmed_CP$Lower.limit*100,1),";",round(Overall_ORR_confirmed_CP$Upper.limit*100,1),"]")

IC_95_confirmed <- c(Overall_ORR_confirmed_CP_IC,
                     CR_confirmed_CP_IC,
                     PR_confirmed_CP_IC,
                     SD_confirmed_CP_IC,
                     PD_confirmed_CP_IC,
                     NE_confirmed_CP_IC)

N_confirmed <- c(Overall_ORR_confirmed,
                 CR_confirmed,
                 PR_confirmed,
                 SD_confirmed,
                 PD_confirmed,
                 NE_confirmed)

Percentage_confirmed <- c(round(Overall_ORR_confirmed/total*100,1),
                          round(CR_confirmed/total*100,1),
                          round(PR_confirmed/total*100,1),
                          round(SD_confirmed/total*100,1),
                          round(PD_confirmed/total*100,1),
                          round(NE_confirmed/total*100,1))

Name <- c("Overall ORR",
          "Complete response (CR)",
          "Partial response (PR)",
          "Stable disease (SD)",
          "Progressive disease (PD)",
          "Non evaluable (NE)")

confirmed_Best_Response_during_treatment <- as.data.frame(cbind(Name,N_confirmed,Percentage_confirmed,IC_95_confirmed))
colnames(confirmed_Best_Response_during_treatment) <- c("Confirmed Best Response during treatment   ",paste0("N=",total),"%","IC 95%")

confirmed_Best_Response_during_treatment =  confirmed_Best_Response_during_treatment %>%
  as_flextable(show_coltype = F, include.row_percent = FALSE, include.column_percent = FALSE, include.table_percent = FALSE) %>%
  delete_rows(i=1, part = "footer") %>%
  bold(i =1, j = 1, bold = TRUE, part = "body") %>%
  bold(bold = TRUE, part = "header") %>%
  surround(i = 1, j = 1:4, border.bottom = fp_border(color = "black", style = "solid", width = 1), part = "body")  %>%
  footnote( i = 1, j = c(4,1),
            value = as_paragraph(
              c("Clopper-Pearson (Exact) method was used for confidence interval",
                "For CR & PR confirmation of response had to be be demonstrated with an assessment 4 weeks or later from the initial response for response. *As stated in the protocol: «For equivocal findings of progression (e.g., very small and uncertain new lesions; cystic changes or necrosis in existing lesions), treatment may continue until the next scheduled assessment». Therefore, some patients had a response after a progressive disease response, in that case best response was examine before and after PD. Scans conducted after initiating new anti-cancer therapy were not included in the ORR analyses")),
            ref_symbols =c("*","1"), part = "header") %>%
  valign(valign = "bottom", part = "header") %>%
  footnote( i = c(6), j = 1,
            value = as_paragraph(
              c("Example : Patient 129 had NE as her global response for target lesion was NE.")),
            ref_symbols = c("2"), part = "body") %>%
  valign(valign = "bottom", part = "header")
confirmed_Best_Response_during_treatment
```

## Clinical Trial with 2 arms

The objectives are the same clinical studies with only 1 arm, we will just add a separation between the 2 arms in the flextable

```{r}
recist_2=recist %>% 
  arrange(as.numeric(subjid), rcdt) %>% 
  distinct(subjid,rcresp, rcdt,arm) %>%
  mutate(rcresp_num=as.factor(rcresp),
         rcresp_num=as.numeric(rcresp_num)
  ) %>% 
  filter(!is.na(rcresp_num)) %>%
  mutate(previous_rcresp_num=lag(rcresp_num),
         previous_date=lag(rcdt),
         delta_date=as.numeric(rcdt - previous_date),
         delta_date= ifelse(is.na(delta_date),0,delta_date),
         delta_date_before_PD_or_end = cumsum(delta_date),
         bestresponse_withinprotocole=ifelse(previous_rcresp_num==rcresp_num, 1, 0 ),
         .by = subjid
  )

recist_2$meilleur_reponse <- recist_2$rcresp_num

recist_2$meilleur_reponse[recist_2$rcresp_num == 1 & 
                             recist_2$previous_rcresp_num == 1 &
                             recist_2$delta_date >= 28] <- 1
recist_2$meilleur_reponse[recist_2$rcresp_num == 1 & 
                             recist_2$previous_rcresp_num == 1 &
                             recist_2$delta_date < 28] <- 3
recist_2$meilleur_reponse[recist_2$rcresp_num == 1 & 
                             recist_2$previous_rcresp_num == 2 &
                             recist_2$delta_date >= 28] <- 2
recist_2$meilleur_reponse[recist_2$rcresp_num == 1 & 
                             recist_2$previous_rcresp_num == 2 &
                             recist_2$delta_date < 28] <- 3
recist_2$meilleur_reponse[recist_2$rcresp_num == 1 & 
                             recist_2$previous_rcresp_num == 3] <- 3
recist_2$meilleur_reponse[recist_2$rcresp_num == 1 & 
                             recist_2$previous_rcresp_num == 4] <- 4
recist_2$meilleur_reponse[recist_2$rcresp_num == 1 & 
                             recist_2$previous_rcresp_num == 5] <- 5

recist_2$meilleur_reponse[recist_2$rcresp_num == 2 & 
                             recist_2$previous_rcresp_num <=2 &
                             recist_2$delta_date >= 28] <- 2
recist_2$meilleur_reponse[recist_2$rcresp_num == 2 & 
                             recist_2$previous_rcresp_num <= 2 &
                             recist_2$delta_date < 28] <- 3
recist_2$meilleur_reponse[recist_2$rcresp_num == 2 & 
                             recist_2$previous_rcresp_num == 3] <- 3
recist_2$meilleur_reponse[recist_2$rcresp_num == 2 & 
                             recist_2$previous_rcresp_num == 4] <- 4
recist_2$meilleur_reponse[recist_2$rcresp_num == 2 & 
                             recist_2$previous_rcresp_num == 5] <- 5

recist_2$meilleur_reponse[is.na(recist_2$previous_rcresp_num) & recist_2$rcresp_num==4] <- 4

final_confirmed_best_response_2_arm=recist_2 %>% 
  mutate(bestresponse=min(meilleur_reponse),
         .by=subjid
  ) %>% 
  filter(bestresponse==meilleur_reponse) %>% 
  slice_head(by=subjid)


#Exemple : patient 129 should be "Not evaluable"
final_confirmed_best_response_2_arm$rcresp[final_confirmed_best_response_2_arm$subjid == 129]<- "Not evaluable"


final_confirmed_best_response_2_arm= final_confirmed_best_response_2_arm %>%
  mutate(Overall_ORR= ifelse(rcresp=="Complete response" | rcresp=="Partial response",1,0))


treatment <-final_confirmed_best_response_2_arm %>% 
  filter(arm=="Treatment")

control <-final_confirmed_best_response_2_arm %>% 
  filter(arm=="Control")

#Since we have 2 arms, we will first create the part of the control patients

total_control <- length(unique(control$subjid))
CR_confirmed_control <- length(control$rcresp[control$rcresp == "Complete response"])
PR_confirmed_control <- length(control$rcresp[control$rcresp == "Partial response"])
SD_confirmed_control <- length(control$rcresp[control$rcresp == "Stable disease"])
PD_confirmed_control <- length(control$rcresp[control$rcresp == "Progressive disease"])
NE_confirmed_control <- length(control$rcresp[control$rcresp == "Not evaluable"])
Overall_ORR_confirmed_control <- CR_confirmed_control + PR_confirmed_control

CR_confirmed_CP_control <- clopper.pearson.ci(CR_confirmed_control,total_control,CI="two.sided", alpha = 0.05)
PR_confirmed_CP_control <- clopper.pearson.ci(PR_confirmed_control,total_control,CI="two.sided", alpha = 0.05)
SD_confirmed_CP_control <- clopper.pearson.ci(SD_confirmed_control,total_control,CI="two.sided", alpha = 0.05)
PD_confirmed_CP_control <- clopper.pearson.ci(PD_confirmed_control,total_control,CI="two.sided", alpha = 0.05)
NE_confirmed_CP_control <- clopper.pearson.ci(NE_confirmed_control,total_control,CI="two.sided", alpha = 0.05)
Overall_ORR_confirmed_CP_control <- clopper.pearson.ci(Overall_ORR_confirmed_control,total_control,CI="two.sided", alpha = 0.05)

CR_confirmed_CP_IC_control <- paste0("[",round(CR_confirmed_CP_control$Lower.limit*100,1),";",round(CR_confirmed_CP_control$Upper.limit*100,1),"]")
PR_confirmed_CP_IC_control <- paste0("[",round(PR_confirmed_CP_control$Lower.limit*100,1),";",round(PR_confirmed_CP_control$Upper.limit*100,1),"]")
SD_confirmed_CP_IC_control <- paste0("[",round(SD_confirmed_CP_control$Lower.limit*100,1),";",round(SD_confirmed_CP_control$Upper.limit*100,1),"]")
PD_confirmed_CP_IC_control <- paste0("[",round(PD_confirmed_CP_control$Lower.limit*100,1),";",round(PD_confirmed_CP_control$Upper.limit*100,1),"]")
NE_confirmed_CP_IC_control <- paste0("[",round(NE_confirmed_CP_control$Lower.limit*100,1),";",round(NE_confirmed_CP_control$Upper.limit*100,1),"]")
Overall_ORR_confirmed_CP_IC_control <- paste0("[",round(Overall_ORR_confirmed_CP_control$Lower.limit*100,1),";",round(Overall_ORR_confirmed_CP_control$Upper.limit*100,1),"]")


IC_95_confirmed_control <- c(Overall_ORR_confirmed_CP_IC_control,
                       CR_confirmed_CP_IC_control,
                       PR_confirmed_CP_IC_control,
                       SD_confirmed_CP_IC_control,
                       PD_confirmed_CP_IC_control,
                       NE_confirmed_CP_IC_control)

Name <- c("Overall ORR",
          "Complete response (CR)",
          "Partial response (PR)",
          "Stable disease (SD)",
          "Progressive disease (PD)",
          "Non evaluable (NE)")

N_confirmed_control <- c(Overall_ORR_confirmed_control,
                   CR_confirmed_control,
                   PR_confirmed_control,
                   SD_confirmed_control,
                   PD_confirmed_control,
                   NE_confirmed_control)

Percentage_confirmed_control <- c(round(Overall_ORR_confirmed_control/total_control*100,1),
                            round(CR_confirmed_control/total_control*100,1),
                            round(PR_confirmed_control/total_control*100,1),
                            round(SD_confirmed_control/total_control*100,1),
                            round(PD_confirmed_control/total_control*100,1),
                            round(NE_confirmed_control/total_control*100,1))

#Then we create the part of the treatment patients

total_treatment <- length(unique(treatment$subjid))
CR_confirmed_treatment <- length(treatment$rcresp[treatment$rcresp == "Complete response"])
PR_confirmed_treatment <- length(treatment$rcresp[treatment$rcresp == "Partial response"])
SD_confirmed_treatment <- length(treatment$rcresp[treatment$rcresp == "Stable disease"])
PD_confirmed_treatment <- length(treatment$rcresp[treatment$rcresp == "Progressive disease"])
NE_confirmed_treatment <- length(treatment$rcresp[treatment$rcresp == "Not evaluable"])
Overall_ORR_confirmed_treatment <- CR_confirmed_treatment + PR_confirmed_treatment

CR_confirmed_CP_treatment <- clopper.pearson.ci(CR_confirmed_treatment,total_treatment,CI="two.sided", alpha = 0.05)
PR_confirmed_CP_treatment <- clopper.pearson.ci(PR_confirmed_treatment,total_treatment,CI="two.sided", alpha = 0.05)
SD_confirmed_CP_treatment <- clopper.pearson.ci(SD_confirmed_treatment,total_treatment,CI="two.sided", alpha = 0.05)
PD_confirmed_CP_treatment <- clopper.pearson.ci(PD_confirmed_treatment,total_treatment,CI="two.sided", alpha = 0.05)
NE_confirmed_CP_treatment <- clopper.pearson.ci(NE_confirmed_treatment,total_treatment,CI="two.sided", alpha = 0.05)
Overall_ORR_confirmed_CP_treatment <- clopper.pearson.ci(Overall_ORR_confirmed_treatment,total_treatment,CI="two.sided", alpha = 0.05)

CR_confirmed_CP_IC_treatment <- paste0("[",round(CR_confirmed_CP_treatment$Lower.limit*100,1),";",round(CR_confirmed_CP_treatment$Upper.limit*100,1),"]")
PR_confirmed_CP_IC_treatment <- paste0("[",round(PR_confirmed_CP_treatment$Lower.limit*100,1),";",round(PR_confirmed_CP_treatment$Upper.limit*100,1),"]")
SD_confirmed_CP_IC_treatment <- paste0("[",round(SD_confirmed_CP_treatment$Lower.limit*100,1),";",round(SD_confirmed_CP_treatment$Upper.limit*100,1),"]")
PD_confirmed_CP_IC_treatment <- paste0("[",round(PD_confirmed_CP_treatment$Lower.limit*100,1),";",round(PD_confirmed_CP_treatment$Upper.limit*100,1),"]")
NE_confirmed_CP_IC_treatment <- paste0("[",round(NE_confirmed_CP_treatment$Lower.limit*100,1),";",round(NE_confirmed_CP_treatment$Upper.limit*100,1),"]")
Overall_ORR_confirmed_CP_IC_treatment <- paste0("[",round(Overall_ORR_confirmed_CP_treatment$Lower.limit*100,1),";",round(Overall_ORR_confirmed_CP_treatment$Upper.limit*100,1),"]")

IC_95_confirmed_treatment <- c(Overall_ORR_confirmed_CP_IC_treatment,
                       CR_confirmed_CP_IC_treatment,
                       PR_confirmed_CP_IC_treatment,
                       SD_confirmed_CP_IC_treatment,
                       PD_confirmed_CP_IC_treatment,
                       NE_confirmed_CP_IC_treatment)

Name <- c("Overall ORR",
          "Complete response (CR)",
          "Partial response (PR)",
          "Stable disease (SD)",
          "Progressive disease (PD)",
          "Non evaluable (NE)")

N_confirmed_treatment <- c(Overall_ORR_confirmed_treatment,
                   CR_confirmed_treatment,
                   PR_confirmed_treatment,
                   SD_confirmed_treatment,
                   PD_confirmed_treatment,
                   NE_confirmed_treatment)

Percentage_confirmed_treatment <- c(round(Overall_ORR_confirmed_treatment/total_treatment*100,1),
                            round(CR_confirmed_treatment/total_treatment*100,1),
                            round(PR_confirmed_treatment/total_treatment*100,1),
                            round(SD_confirmed_treatment/total_treatment*100,1),
                            round(PD_confirmed_treatment/total_treatment*100,1),
                            round(NE_confirmed_treatment/total_treatment*100,1))


#Finnaly we merge the 2 arms

confirmed_Best_Response_during_treatment_2_arms <- as.data.frame(cbind(Name,
                                                                         N_confirmed_control,
                                                                         Percentage_confirmed_control,
                                                                         IC_95_confirmed_control,
                                                                         N_confirmed_treatment,
                                                                         Percentage_confirmed_treatment,
                                                                         IC_95_confirmed_treatment))


colnames(confirmed_Best_Response_during_treatment_2_arms) <- c("Confirmed Best Response during treatmen",
                                                                 paste0("Control_N=",total_control),
                                                                 "Control_%",
                                                                 "Control_IC 95%",
                                                                 paste0("Treatment_N=",total_treatment),
                                                                 "Treatment_%",
                                                                 "Treatment_IC 95%")
confirmed_Best_Response_during_treatment_2_arms =  confirmed_Best_Response_during_treatment_2_arms %>%
  as_flextable(show_coltype = F, include.row_percent = FALSE, include.column_percent = FALSE, include.table_percent = FALSE) %>%
  delete_rows(i=1, part = "footer") %>%
  separate_header() %>% 
  align(align = "center", part = "header") %>%
  align(align = "center", part = "body") %>%
  bold(bold = TRUE, part = "header") %>%
  bold(i = 1, j = 1, bold = TRUE, part = "body") %>%
  surround(i = 1, j = 1:7, border.bottom = fp_border(color = "black", style = "solid", width = 1), part = "body")  %>%
  footnote( i = 2, j = c(4,7),
            value = as_paragraph(
              c("Clopper-Pearson (Exact) method was used for confidence interval")),
            ref_symbols =c("*"), part = "header") %>%
  footnote( i = 1, j = 1,
            value = as_paragraph(
              c("For CR & PR confirmation of response had to be be demonstrated with an assessment 4 weeks or later from the initial response for response. *As stated in the protocol: «For equivocal findings of progression (e.g., very small and uncertain new lesions; cystic changes or necrosis in existing lesions), treatment may continue until the next scheduled assessment». Therefore, some patients had a response after a progressive disease response, in that case best response was examine before and after PD. Scans conducted after initiating new anti-cancer therapy were not included in the ORR analyses")),
            ref_symbols =c("1"), part = "header") %>%
  valign(valign = "bottom", part = "header") %>%
  footnote( i = 6, j = 1,
            value = as_paragraph(
              c("Example : Patient 129 had NE as her global response for target lesion was NE.")),
            ref_symbols = c("2"), part = "body") %>%
  valign(valign = "bottom", part = "header") %>%
  vline(j = c(1,4), border = fp_border(color = "black", style = "solid", width = 2)) %>%
  autofit()
confirmed_Best_Response_during_treatment_2_arms
```


# Clinical Benefit Rate (CBR)

There is 2 different methods to calculate the CBR : 

-   At least a "Stable Disease" lasting for at least the 4 next consecutive visits

-   At least a "Stable Disease"  lasting for at least the 6 next consecutive months

## Cases with 4 consecutive visits for CBR

### Clinical Trial with only 1 arm

For CBR, since we already know which patients have had a "Partial Response" (PR) or a "Complete Response" (CR), we will now look at which patients have had at least a "Stable Disease" lasting for at least the 4 next consecutive visits

```{r}
CBR_unconfirmed=unconfirmed_best_response %>% 
  select(subjid) %>% 
  left_join(recist, by = "subjid") %>% 
  arrange(subjid, rcdt) %>% 
  distinct(subjid, rcdt,rcresp) %>% 
  filter(!is.na(rcresp)) %>% 
  mutate(sequence=row_number(),
         .by = subjid
  ) %>% 
  filter(rcresp=="Stable disease" |
         rcresp=="Partial response" |
         rcresp=="Complete response") %>% 
  mutate(max_sequence=max(sequence),
         min_sequence=min(sequence),
         diff_sequence=max_sequence-min_sequence,
         count=n(),
         .by = subjid
  ) %>%
  filter(count>3 & 
         diff_sequence>3 & 
         (min_sequence==sequence|max_sequence==sequence)
  ) %>% 
  slice_head(by = subjid) %>% 
  select(subjid,rcresp) 

final_unconfirmed_best_response= final_unconfirmed_best_response %>%
  mutate(CBR= ifelse(rcresp=="Complete response" | rcresp=="Partial response",1,0),
         CBR= ifelse(subjid %in% CBR_unconfirmed$subjid,1,CBR))
```

And now we can create a flextable with an addition of CBR
```{r}
total <- length(unique(final_unconfirmed_best_response$subjid))
CR_unconfirmed <- length(final_unconfirmed_best_response$rcresp[final_unconfirmed_best_response$rcresp == "Complete response"])
PR_unconfirmed <- length(final_unconfirmed_best_response$rcresp[final_unconfirmed_best_response$rcresp == "Partial response"])
SD_unconfirmed <- length(final_unconfirmed_best_response$rcresp[final_unconfirmed_best_response$rcresp == "Stable disease"])
PD_unconfirmed <- length(final_unconfirmed_best_response$rcresp[final_unconfirmed_best_response$rcresp == "Progressive disease"])
NE_unconfirmed <- length(final_unconfirmed_best_response$rcresp[final_unconfirmed_best_response$rcresp == "Not evaluable"])
Overall_ORR_unconfirmed <- CR_unconfirmed + PR_unconfirmed
CBR_unconfirmed <- length(final_unconfirmed_best_response$CBR[final_unconfirmed_best_response$CBR==1])

CR_unconfirmed_CP <- clopper.pearson.ci(CR_unconfirmed,total,CI="two.sided", alpha = 0.05)
PR_unconfirmed_CP <- clopper.pearson.ci(PR_unconfirmed,total,CI="two.sided", alpha = 0.05)
SD_unconfirmed_CP <- clopper.pearson.ci(SD_unconfirmed,total,CI="two.sided", alpha = 0.05)
PD_unconfirmed_CP <- clopper.pearson.ci(PD_unconfirmed,total,CI="two.sided", alpha = 0.05)
NE_unconfirmed_CP <- clopper.pearson.ci(NE_unconfirmed,total,CI="two.sided", alpha = 0.05)
Overall_ORR_unconfirmed_CP <- clopper.pearson.ci(Overall_ORR_unconfirmed,total,CI="two.sided", alpha = 0.05)
CBR_unconfirmed_CP <- clopper.pearson.ci(CBR_unconfirmed,total,CI="two.sided", alpha = 0.05)

CR_unconfirmed_CP_IC <- paste0("[",round(CR_unconfirmed_CP$Lower.limit*100,1),";",round(CR_unconfirmed_CP$Upper.limit*100,1),"]")
PR_unconfirmed_CP_IC <- paste0("[",round(PR_unconfirmed_CP$Lower.limit*100,1),";",round(PR_unconfirmed_CP$Upper.limit*100,1),"]")
SD_unconfirmed_CP_IC <- paste0("[",round(SD_unconfirmed_CP$Lower.limit*100,1),";",round(SD_unconfirmed_CP$Upper.limit*100,1),"]")
PD_unconfirmed_CP_IC <- paste0("[",round(PD_unconfirmed_CP$Lower.limit*100,1),";",round(PD_unconfirmed_CP$Upper.limit*100,1),"]")
NE_unconfirmed_CP_IC <- paste0("[",round(NE_unconfirmed_CP$Lower.limit*100,1),";",round(NE_unconfirmed_CP$Upper.limit*100,1),"]")
Overall_ORR_unconfirmed_CP_IC <- paste0("[",round(Overall_ORR_unconfirmed_CP$Lower.limit*100,1),";",round(Overall_ORR_unconfirmed_CP$Upper.limit*100,1),"]")
CBR_unconfirmed_CP_IC <- paste0("[",round(CBR_unconfirmed_CP$Lower.limit*100,1),";",round(CBR_unconfirmed_CP$Upper.limit*100,1),"]")

IC_95_unconfirmed <- c(Overall_ORR_unconfirmed_CP_IC,
                       CR_unconfirmed_CP_IC,
                       PR_unconfirmed_CP_IC,
                       SD_unconfirmed_CP_IC,
                       PD_unconfirmed_CP_IC,
                       NE_unconfirmed_CP_IC,
                       CBR_unconfirmed_CP_IC)

Name <- c("Overall ORR",
          "Complete response (CR)",
          "Partial response (PR)",
          "Stable disease (SD)",
          "Progressive disease (PD)",
          "Non evaluable (NE)",
          "Clinical Benefit Rate (CBR)")

N_unconfirmed <- c(Overall_ORR_unconfirmed,
                   CR_unconfirmed,
                   PR_unconfirmed,
                   SD_unconfirmed,
                   PD_unconfirmed,
                   NE_unconfirmed,
                   CBR_unconfirmed)

Percentage_unconfirmed <- c(round(Overall_ORR_unconfirmed/total*100,1),
                            round(CR_unconfirmed/total*100,1),
                            round(PR_unconfirmed/total*100,1),
                            round(SD_unconfirmed/total*100,1),
                            round(PD_unconfirmed/total*100,1),
                            round(NE_unconfirmed/total*100,1),
                            round(CBR_unconfirmed/total*100,1))

unconfirmed_Best_Response_during_treatment <- as.data.frame(cbind(Name,N_unconfirmed,Percentage_unconfirmed,IC_95_unconfirmed))
colnames(unconfirmed_Best_Response_during_treatment) <- c("Unconfirmed Best Response during treatment",paste0("N=",total),"%","IC 95%")
unconfirmed_Best_Response_during_treatment =  unconfirmed_Best_Response_during_treatment %>%
  as_flextable(show_coltype = F, include.row_percent = FALSE, include.column_percent = FALSE, include.table_percent = FALSE) %>%
  delete_rows(i=1, part = "footer") %>%
  bold(i = c(1,7), j = 1, bold = TRUE, part = "body") %>%
  bold(bold = TRUE, part = "header") %>%
  surround(i = c(1,6), j = 1:4, border.bottom = fp_border(color = "black", style = "solid", width = 1), part = "body")  %>%
  footnote( i = 1, j = 4,
            value = as_paragraph(
              c("Clopper-Pearson (Exact) method was used for confidence interval")),
            ref_symbols ="*", part = "header") %>%
  valign(valign = "bottom", part = "header") %>%
  footnote( i = c(6,7), j = 1,
            value = as_paragraph(
              c("Example : Patient 129 had NE as her global response for target lesion was NE.",
                "CBR was defined as the presence of at least a partial response (PR), complete response (CR), or stable disease (SD) lasting for at least the 4 next consecutive visits.")),
            ref_symbols = c("1", "2"), part = "body") %>%
  valign(valign = "bottom", part = "header")

unconfirmed_Best_Response_during_treatment
```

### Clinical Trial with 2 arms

Objectives are the same clinical studies with only 1 arm, we will just add a separation between the 2 arms in the flextable

```{r}
CBR_unconfirmed_2_arm=unconfirmed_best_response_2_arm %>% 
  select(subjid) %>% 
  left_join(recist, by = "subjid") %>% 
  arrange(subjid, rcdt) %>% 
  distinct(subjid, rcdt,rcresp,arm) %>% 
  filter(!is.na(rcresp)) %>% 
  mutate(sequence=row_number(),
         .by = subjid
  ) %>% 
  filter(rcresp=="Stable disease" |
         rcresp=="Partial response" |
         rcresp=="Complete response") %>% 
  mutate(max_sequence=max(sequence),
         min_sequence=min(sequence),
         diff_sequence=max_sequence-min_sequence,
         count=n(),
         .by = subjid
  ) %>%
  filter(count>3 & 
         diff_sequence>3 & 
         (min_sequence==sequence|max_sequence==sequence)
  ) %>% 
  slice_head(by = subjid) %>% 
  select(subjid,rcresp,arm) 

final_unconfirmed_best_response_2_arm= final_unconfirmed_best_response_2_arm %>%
  mutate(CBR= ifelse(rcresp=="Complete response" | rcresp=="Partial response",1,0),
         CBR= ifelse(subjid %in% CBR_unconfirmed_2_arm$subjid,1,CBR))


treatment <-final_unconfirmed_best_response_2_arm %>% 
  filter(arm=="Treatment")

control <-final_unconfirmed_best_response_2_arm %>% 
  filter(arm=="Control")

total_control <- length(unique(control$subjid))
CR_unconfirmed_control <- length(control$rcresp[control$rcresp == "Complete response"])
PR_unconfirmed_control <- length(control$rcresp[control$rcresp == "Partial response"])
SD_unconfirmed_control <- length(control$rcresp[control$rcresp == "Stable disease"])
PD_unconfirmed_control <- length(control$rcresp[control$rcresp == "Progressive disease"])
NE_unconfirmed_control <- length(control$rcresp[control$rcresp == "Not evaluable"])
Overall_ORR_unconfirmed_control <- CR_unconfirmed_control + PR_unconfirmed_control
CBR_unconfirmed_control <- length(control$CBR[control$CBR==1])

CR_unconfirmed_CP_control <- clopper.pearson.ci(CR_unconfirmed_control,total_control,CI="two.sided", alpha = 0.05)
PR_unconfirmed_CP_control <- clopper.pearson.ci(PR_unconfirmed_control,total_control,CI="two.sided", alpha = 0.05)
SD_unconfirmed_CP_control <- clopper.pearson.ci(SD_unconfirmed_control,total_control,CI="two.sided", alpha = 0.05)
PD_unconfirmed_CP_control <- clopper.pearson.ci(PD_unconfirmed_control,total_control,CI="two.sided", alpha = 0.05)
NE_unconfirmed_CP_control <- clopper.pearson.ci(NE_unconfirmed_control,total_control,CI="two.sided", alpha = 0.05)
Overall_ORR_unconfirmed_CP_control <- clopper.pearson.ci(Overall_ORR_unconfirmed_control,total_control,CI="two.sided", alpha = 0.05)
CBR_unconfirmed_CP_control <- clopper.pearson.ci(CBR_unconfirmed_control,total_control,CI="two.sided", alpha = 0.05)

CR_unconfirmed_CP_IC_control <- paste0("[",round(CR_unconfirmed_CP_control$Lower.limit*100,1),";",round(CR_unconfirmed_CP_control$Upper.limit*100,1),"]")
PR_unconfirmed_CP_IC_control <- paste0("[",round(PR_unconfirmed_CP_control$Lower.limit*100,1),";",round(PR_unconfirmed_CP_control$Upper.limit*100,1),"]")
SD_unconfirmed_CP_IC_control <- paste0("[",round(SD_unconfirmed_CP_control$Lower.limit*100,1),";",round(SD_unconfirmed_CP_control$Upper.limit*100,1),"]")
PD_unconfirmed_CP_IC_control <- paste0("[",round(PD_unconfirmed_CP_control$Lower.limit*100,1),";",round(PD_unconfirmed_CP_control$Upper.limit*100,1),"]")
NE_unconfirmed_CP_IC_control <- paste0("[",round(NE_unconfirmed_CP_control$Lower.limit*100,1),";",round(NE_unconfirmed_CP_control$Upper.limit*100,1),"]")
Overall_ORR_unconfirmed_CP_IC_control <- paste0("[",round(Overall_ORR_unconfirmed_CP_control$Lower.limit*100,1),";",round(Overall_ORR_unconfirmed_CP_control$Upper.limit*100,1),"]")
CBR_unconfirmed_CP_IC_control <- paste0("[",round(CBR_unconfirmed_CP_control$Lower.limit*100,1),";",round(CBR_unconfirmed_CP_control$Upper.limit*100,1),"]")

IC_95_unconfirmed_control <- c(Overall_ORR_unconfirmed_CP_IC_control,
                       CR_unconfirmed_CP_IC_control,
                       PR_unconfirmed_CP_IC_control,
                       SD_unconfirmed_CP_IC_control,
                       PD_unconfirmed_CP_IC_control,
                       NE_unconfirmed_CP_IC_control,
                       CBR_unconfirmed_CP_IC_control)

Name <- c("Overall ORR",
          "Complete response (CR)",
          "Partial response (PR)",
          "Stable disease (SD)",
          "Progressive disease (PD)",
          "Non evaluable (NE)",
          "Clinical Benefit Rate (CBR)")

N_unconfirmed_control <- c(Overall_ORR_unconfirmed_control,
                   CR_unconfirmed_control,
                   PR_unconfirmed_control,
                   SD_unconfirmed_control,
                   PD_unconfirmed_control,
                   NE_unconfirmed_control,
                   CBR_unconfirmed_control)

Percentage_unconfirmed_control <- c(round(Overall_ORR_unconfirmed_control/total_control*100,1),
                            round(CR_unconfirmed_control/total_control*100,1),
                            round(PR_unconfirmed_control/total_control*100,1),
                            round(SD_unconfirmed_control/total_control*100,1),
                            round(PD_unconfirmed_control/total_control*100,1),
                            round(NE_unconfirmed_control/total_control*100,1),
                            round(CBR_unconfirmed_control/total_control*100,1))

total_treatment <- length(unique(treatment$subjid))
CR_unconfirmed_treatment <- length(treatment$rcresp[treatment$rcresp == "Complete response"])
PR_unconfirmed_treatment <- length(treatment$rcresp[treatment$rcresp == "Partial response"])
SD_unconfirmed_treatment <- length(treatment$rcresp[treatment$rcresp == "Stable disease"])
PD_unconfirmed_treatment <- length(treatment$rcresp[treatment$rcresp == "Progressive disease"])
NE_unconfirmed_treatment <- length(treatment$rcresp[treatment$rcresp == "Not evaluable"])
Overall_ORR_unconfirmed_treatment <- CR_unconfirmed_treatment + PR_unconfirmed_treatment
CBR_unconfirmed_treatment <- length(treatment$CBR[treatment$CBR==1])

CR_unconfirmed_CP_treatment <- clopper.pearson.ci(CR_unconfirmed_treatment,total_treatment,CI="two.sided", alpha = 0.05)
PR_unconfirmed_CP_treatment <- clopper.pearson.ci(PR_unconfirmed_treatment,total_treatment,CI="two.sided", alpha = 0.05)
SD_unconfirmed_CP_treatment <- clopper.pearson.ci(SD_unconfirmed_treatment,total_treatment,CI="two.sided", alpha = 0.05)
PD_unconfirmed_CP_treatment <- clopper.pearson.ci(PD_unconfirmed_treatment,total_treatment,CI="two.sided", alpha = 0.05)
NE_unconfirmed_CP_treatment <- clopper.pearson.ci(NE_unconfirmed_treatment,total_treatment,CI="two.sided", alpha = 0.05)
Overall_ORR_unconfirmed_CP_treatment <- clopper.pearson.ci(Overall_ORR_unconfirmed_treatment,total_treatment,CI="two.sided", alpha = 0.05)
CBR_unconfirmed_CP_treatment <- clopper.pearson.ci(CBR_unconfirmed_treatment,total_treatment,CI="two.sided", alpha = 0.05)

CR_unconfirmed_CP_IC_treatment <- paste0("[",round(CR_unconfirmed_CP_treatment$Lower.limit*100,1),";",round(CR_unconfirmed_CP_treatment$Upper.limit*100,1),"]")
PR_unconfirmed_CP_IC_treatment <- paste0("[",round(PR_unconfirmed_CP_treatment$Lower.limit*100,1),";",round(PR_unconfirmed_CP_treatment$Upper.limit*100,1),"]")
SD_unconfirmed_CP_IC_treatment <- paste0("[",round(SD_unconfirmed_CP_treatment$Lower.limit*100,1),";",round(SD_unconfirmed_CP_treatment$Upper.limit*100,1),"]")
PD_unconfirmed_CP_IC_treatment <- paste0("[",round(PD_unconfirmed_CP_treatment$Lower.limit*100,1),";",round(PD_unconfirmed_CP_treatment$Upper.limit*100,1),"]")
NE_unconfirmed_CP_IC_treatment <- paste0("[",round(NE_unconfirmed_CP_treatment$Lower.limit*100,1),";",round(NE_unconfirmed_CP_treatment$Upper.limit*100,1),"]")
Overall_ORR_unconfirmed_CP_IC_treatment <- paste0("[",round(Overall_ORR_unconfirmed_CP_treatment$Lower.limit*100,1),";",round(Overall_ORR_unconfirmed_CP_treatment$Upper.limit*100,1),"]")
CBR_unconfirmed_CP_IC_treatment <- paste0("[",round(CBR_unconfirmed_CP_treatment$Lower.limit*100,1),";",round(CBR_unconfirmed_CP_treatment$Upper.limit*100,1),"]")

IC_95_unconfirmed_treatment <- c(Overall_ORR_unconfirmed_CP_IC_treatment,
                       CR_unconfirmed_CP_IC_treatment,
                       PR_unconfirmed_CP_IC_treatment,
                       SD_unconfirmed_CP_IC_treatment,
                       PD_unconfirmed_CP_IC_treatment,
                       NE_unconfirmed_CP_IC_treatment,
                       CBR_unconfirmed_CP_IC_treatment)

Name <- c("Overall ORR",
          "Complete response (CR)",
          "Partial response (PR)",
          "Stable disease (SD)",
          "Progressive disease (PD)",
          "Non evaluable (NE)",
          "Clinical Benefit Rate (CBR)")

N_unconfirmed_treatment <- c(Overall_ORR_unconfirmed_treatment,
                   CR_unconfirmed_treatment,
                   PR_unconfirmed_treatment,
                   SD_unconfirmed_treatment,
                   PD_unconfirmed_treatment,
                   NE_unconfirmed_treatment,
                   CBR_unconfirmed_treatment)

Percentage_unconfirmed_treatment <- c(round(Overall_ORR_unconfirmed_treatment/total_treatment*100,1),
                            round(CR_unconfirmed_treatment/total_treatment*100,1),
                            round(PR_unconfirmed_treatment/total_treatment*100,1),
                            round(SD_unconfirmed_treatment/total_treatment*100,1),
                            round(PD_unconfirmed_treatment/total_treatment*100,1),
                            round(NE_unconfirmed_treatment/total_treatment*100,1),
                            round(CBR_unconfirmed_treatment/total_treatment*100,1))


unconfirmed_Best_Response_during_treatment_2_arms <- as.data.frame(cbind(Name,
                                                                         N_unconfirmed_control,
                                                                         Percentage_unconfirmed_control,
                                                                         IC_95_unconfirmed_control,
                                                                         N_unconfirmed_treatment,
                                                                         Percentage_unconfirmed_treatment,
                                                                         IC_95_unconfirmed_treatment))
colnames(unconfirmed_Best_Response_during_treatment_2_arms) <- c("Unconfirmed Best Response during treatmen",
                                                                 paste0("Control_N=",total_control),
                                                                 "Control_%",
                                                                 "Control_IC 95%",
                                                                 paste0("Treatment_N=",total_treatment),
                                                                 "Treatment_%",
                                                                 "Treatment_IC 95%")
unconfirmed_Best_Response_during_treatment_2_arms =  unconfirmed_Best_Response_during_treatment_2_arms %>%
  as_flextable(show_coltype = F, include.row_percent = FALSE, include.column_percent = FALSE, include.table_percent = FALSE) %>%
  delete_rows(i=1, part = "footer") %>%
  separate_header() %>% 
  align(align = "center", part = "header") %>%
  align(align = "center", part = "body") %>%
  bold(bold = TRUE, part = "header") %>%
  bold(i = c(1,7), j = 1, bold = TRUE, part = "body") %>%
  surround(i = c(1,6), j = 1:7, border.bottom = fp_border(color = "black", style = "solid", width = 1), part = "body")  %>%
  footnote( i = 2, j = c(4,7),
            value = as_paragraph(
              c("Clopper-Pearson (Exact) method was used for confidence interval")),
            ref_symbols ="*", part = "header") %>%
  valign(valign = "bottom", part = "header") %>%
  footnote( i = c(6,7), j = 1,
            value = as_paragraph(
              c("Example : Patient 129 had NE as her global response for target lesion was NE.",
                "CBR was defined as the presence of at least a partial response (PR), complete response (CR), or stable disease (SD) lasting for at least the 4 next consecutive visits.")),
            ref_symbols = c("1", "2"), part = "body") %>%
  valign(valign = "bottom", part = "header") %>%
  vline(j = c(1,4), border = fp_border(color = "black", style = "solid", width = 2)) %>%
  autofit()
unconfirmed_Best_Response_during_treatment_2_arms
```


## Cases with 6 consecutive months for CBR

### Clinical Trial with only 1 arm

For CBR, since we already know which patients have had a "Partial Response" (PR) or a "Complete Response" (CR), we will now look at which patients have had at least a "Stable Disease" lasting for at least the 6 next consecutive months

```{r}
CBR_unconfirmed_2=recist  %>% 
  arrange(subjid, rcdt) %>% 
  distinct(subjid, rcdt,rcresp) %>% 
  mutate(previous_date=lag(rcdt),
         delta_date=as.numeric(rcdt - previous_date),
         delta_date= replace_na(delta_date,0),
         delta_date_before_PD_or_end = cumsum(delta_date),
         delta_date_before_PD_or_end = ifelse(rcresp=="Progressive disease" ,0,delta_date_before_PD_or_end),
         delta_date_before_PD_or_end= replace_na(delta_date_before_PD_or_end,0),
         duree_suivi_max = max(delta_date_before_PD_or_end),
         CBR_2 = ifelse(duree_suivi_max >= 152,1,0),
         .by=subjid
  ) %>%
  slice_tail(by = subjid) %>%
  select(subjid,duree_suivi_max,CBR_2) 

final_unconfirmed_best_response= final_unconfirmed_best_response %>%
  left_join(CBR_unconfirmed_2, by = "subjid") %>%
  mutate(CBR_2 = ifelse(duree_suivi_max >= 152 | rcresp=="Complete response" | rcresp=="Partial response",1,0))
```

Et le flextable qui va avec pour 1 bras
```{r}
total <- length(unique(final_unconfirmed_best_response$subjid))
CR_unconfirmed <- length(final_unconfirmed_best_response$rcresp[final_unconfirmed_best_response$rcresp == "Complete response"])
PR_unconfirmed <- length(final_unconfirmed_best_response$rcresp[final_unconfirmed_best_response$rcresp == "Partial response"])
SD_unconfirmed <- length(final_unconfirmed_best_response$rcresp[final_unconfirmed_best_response$rcresp == "Stable disease"])
PD_unconfirmed <- length(final_unconfirmed_best_response$rcresp[final_unconfirmed_best_response$rcresp == "Progressive disease"])
NE_unconfirmed <- length(final_unconfirmed_best_response$rcresp[final_unconfirmed_best_response$rcresp == "Not evaluable"])
Overall_ORR_unconfirmed <- CR_unconfirmed + PR_unconfirmed
CBR_unconfirmed <- length(final_unconfirmed_best_response$CBR_2[final_unconfirmed_best_response$CBR_2==1])

CR_unconfirmed_CP <- clopper.pearson.ci(CR_unconfirmed,total,CI="two.sided", alpha = 0.05)
PR_unconfirmed_CP <- clopper.pearson.ci(PR_unconfirmed,total,CI="two.sided", alpha = 0.05)
SD_unconfirmed_CP <- clopper.pearson.ci(SD_unconfirmed,total,CI="two.sided", alpha = 0.05)
PD_unconfirmed_CP <- clopper.pearson.ci(PD_unconfirmed,total,CI="two.sided", alpha = 0.05)
NE_unconfirmed_CP <- clopper.pearson.ci(NE_unconfirmed,total,CI="two.sided", alpha = 0.05)
Overall_ORR_unconfirmed_CP <- clopper.pearson.ci(Overall_ORR_unconfirmed,total,CI="two.sided", alpha = 0.05)
CBR_unconfirmed_CP <- clopper.pearson.ci(CBR_unconfirmed,total,CI="two.sided", alpha = 0.05)

CR_unconfirmed_CP_IC <- paste0("[",round(CR_unconfirmed_CP$Lower.limit*100,1),";",round(CR_unconfirmed_CP$Upper.limit*100,1),"]")
PR_unconfirmed_CP_IC <- paste0("[",round(PR_unconfirmed_CP$Lower.limit*100,1),";",round(PR_unconfirmed_CP$Upper.limit*100,1),"]")
SD_unconfirmed_CP_IC <- paste0("[",round(SD_unconfirmed_CP$Lower.limit*100,1),";",round(SD_unconfirmed_CP$Upper.limit*100,1),"]")
PD_unconfirmed_CP_IC <- paste0("[",round(PD_unconfirmed_CP$Lower.limit*100,1),";",round(PD_unconfirmed_CP$Upper.limit*100,1),"]")
NE_unconfirmed_CP_IC <- paste0("[",round(NE_unconfirmed_CP$Lower.limit*100,1),";",round(NE_unconfirmed_CP$Upper.limit*100,1),"]")
Overall_ORR_unconfirmed_CP_IC <- paste0("[",round(Overall_ORR_unconfirmed_CP$Lower.limit*100,1),";",round(Overall_ORR_unconfirmed_CP$Upper.limit*100,1),"]")
CBR_unconfirmed_CP_IC <- paste0("[",round(CBR_unconfirmed_CP$Lower.limit*100,1),";",round(CBR_unconfirmed_CP$Upper.limit*100,1),"]")

IC_95_unconfirmed <- c(Overall_ORR_unconfirmed_CP_IC,
                       CR_unconfirmed_CP_IC,
                       PR_unconfirmed_CP_IC,
                       SD_unconfirmed_CP_IC,
                       PD_unconfirmed_CP_IC,
                       NE_unconfirmed_CP_IC,
                       CBR_unconfirmed_CP_IC)

Name <- c("Overall ORR",
          "Complete response (CR)",
          "Partial response (PR)",
          "Stable disease (SD)",
          "Progressive disease (PD)",
          "Non evaluable (NE)",
          "Clinical Benefit Rate (CBR)")

N_unconfirmed <- c(Overall_ORR_unconfirmed,
                   CR_unconfirmed,
                   PR_unconfirmed,
                   SD_unconfirmed,
                   PD_unconfirmed,
                   NE_unconfirmed,
                   CBR_unconfirmed)

Percentage_unconfirmed <- c(round(Overall_ORR_unconfirmed/total*100,1),
                            round(CR_unconfirmed/total*100,1),
                            round(PR_unconfirmed/total*100,1),
                            round(SD_unconfirmed/total*100,1),
                            round(PD_unconfirmed/total*100,1),
                            round(NE_unconfirmed/total*100,1),
                            round(CBR_unconfirmed/total*100,1))

unconfirmed_Best_Response_during_treatment <- as.data.frame(cbind(Name,N_unconfirmed,Percentage_unconfirmed,IC_95_unconfirmed))
colnames(unconfirmed_Best_Response_during_treatment) <- c("Unconfirmed Best Response during treatment",paste0("N=",total),"%","IC 95%")
unconfirmed_Best_Response_during_treatment =  unconfirmed_Best_Response_during_treatment %>%
  as_flextable(show_coltype = F, include.row_percent = FALSE, include.column_percent = FALSE, include.table_percent = FALSE) %>%
  delete_rows(i=1, part = "footer") %>%
  bold(i = c(1,7), j = 1, bold = TRUE, part = "body") %>%
  bold(bold = TRUE, part = "header") %>%
  surround(i = c(1,6), j = 1:4, border.bottom = fp_border(color = "black", style = "solid", width = 1), part = "body")  %>%
  footnote( i = 1, j = 4,
            value = as_paragraph(
              c("Clopper-Pearson (Exact) method was used for confidence interval")),
            ref_symbols ="*", part = "header") %>%
  valign(valign = "bottom", part = "header") %>%
  footnote( i = c(6,7), j = 1,
            value = as_paragraph(
              c("Example : Patient 129 had NE as her global response for target lesion was NE.",
                "CBR was defined as the presence of at least a partial response (PR), complete response (CR), or stable disease (SD) lasting at least six months (using a window of +/-1 month for the RECIST date).")),
            ref_symbols = c("1", "2"), part = "body") %>%
  valign(valign = "bottom", part = "header")

unconfirmed_Best_Response_during_treatment
```

### Clinical Trial with 2 arms

Objectives are the same clinical studies with only 1 arm, we will just add a separation between the 2 arms in the flextable

```{r}
CBR_unconfirmed_2_arm_2=recist  %>% 
  arrange(subjid, rcdt) %>% 
  distinct(subjid, rcdt,rcresp) %>% 
  mutate(previous_date=lag(rcdt),
         delta_date=as.numeric(rcdt - previous_date),
         delta_date= replace_na(delta_date,0),
         delta_date_before_PD_or_end = cumsum(delta_date),
         delta_date_before_PD_or_end = ifelse(rcresp=="Progressive disease" ,0,delta_date_before_PD_or_end),
         delta_date_before_PD_or_end= replace_na(delta_date_before_PD_or_end,0),
         duree_suivi_max = max(delta_date_before_PD_or_end),
         CBR_2 = ifelse(duree_suivi_max >= 152,1,0),
         .by=subjid
  ) %>%
  slice_tail(by = subjid) %>%
  select(subjid,duree_suivi_max,CBR_2)  

final_unconfirmed_best_response_2_arm= final_unconfirmed_best_response_2_arm %>%
  left_join(CBR_unconfirmed_2_arm_2, by = "subjid") %>%
  mutate(CBR_2 = ifelse(duree_suivi_max >= 152 | rcresp=="Complete response" | rcresp=="Partial response",1,0))


treatment <-final_unconfirmed_best_response_2_arm %>% 
  filter(arm=="Treatment")

control <-final_unconfirmed_best_response_2_arm %>% 
  filter(arm=="Control")


#Dans un premier temps on gére le bras controle : 

total_control <- length(unique(control$subjid))
CR_unconfirmed_control <- length(control$rcresp[control$rcresp == "Complete response"])
PR_unconfirmed_control <- length(control$rcresp[control$rcresp == "Partial response"])
SD_unconfirmed_control <- length(control$rcresp[control$rcresp == "Stable disease"])
PD_unconfirmed_control <- length(control$rcresp[control$rcresp == "Progressive disease"])
NE_unconfirmed_control <- length(control$rcresp[control$rcresp == "Not evaluable"])
Overall_ORR_unconfirmed_control <- CR_unconfirmed_control + PR_unconfirmed_control
CBR_unconfirmed_control <- length(control$CBR_2[control$CBR_2==1])

CR_unconfirmed_CP_control <- clopper.pearson.ci(CR_unconfirmed_control,total_control,CI="two.sided", alpha = 0.05)
PR_unconfirmed_CP_control <- clopper.pearson.ci(PR_unconfirmed_control,total_control,CI="two.sided", alpha = 0.05)
SD_unconfirmed_CP_control <- clopper.pearson.ci(SD_unconfirmed_control,total_control,CI="two.sided", alpha = 0.05)
PD_unconfirmed_CP_control <- clopper.pearson.ci(PD_unconfirmed_control,total_control,CI="two.sided", alpha = 0.05)
NE_unconfirmed_CP_control <- clopper.pearson.ci(NE_unconfirmed_control,total_control,CI="two.sided", alpha = 0.05)
Overall_ORR_unconfirmed_CP_control <- clopper.pearson.ci(Overall_ORR_unconfirmed_control,total_control,CI="two.sided", alpha = 0.05)
CBR_unconfirmed_CP_control <- clopper.pearson.ci(CBR_unconfirmed_control,total_control,CI="two.sided", alpha = 0.05)

CR_unconfirmed_CP_IC_control <- paste0("[",round(CR_unconfirmed_CP_control$Lower.limit*100,1),";",round(CR_unconfirmed_CP_control$Upper.limit*100,1),"]")
PR_unconfirmed_CP_IC_control <- paste0("[",round(PR_unconfirmed_CP_control$Lower.limit*100,1),";",round(PR_unconfirmed_CP_control$Upper.limit*100,1),"]")
SD_unconfirmed_CP_IC_control <- paste0("[",round(SD_unconfirmed_CP_control$Lower.limit*100,1),";",round(SD_unconfirmed_CP_control$Upper.limit*100,1),"]")
PD_unconfirmed_CP_IC_control <- paste0("[",round(PD_unconfirmed_CP_control$Lower.limit*100,1),";",round(PD_unconfirmed_CP_control$Upper.limit*100,1),"]")
NE_unconfirmed_CP_IC_control <- paste0("[",round(NE_unconfirmed_CP_control$Lower.limit*100,1),";",round(NE_unconfirmed_CP_control$Upper.limit*100,1),"]")
Overall_ORR_unconfirmed_CP_IC_control <- paste0("[",round(Overall_ORR_unconfirmed_CP_control$Lower.limit*100,1),";",round(Overall_ORR_unconfirmed_CP_control$Upper.limit*100,1),"]")
CBR_unconfirmed_CP_IC_control <- paste0("[",round(CBR_unconfirmed_CP_control$Lower.limit*100,1),";",round(CBR_unconfirmed_CP_control$Upper.limit*100,1),"]")

IC_95_unconfirmed_control <- c(Overall_ORR_unconfirmed_CP_IC_control,
                       CR_unconfirmed_CP_IC_control,
                       PR_unconfirmed_CP_IC_control,
                       SD_unconfirmed_CP_IC_control,
                       PD_unconfirmed_CP_IC_control,
                       NE_unconfirmed_CP_IC_control,
                       CBR_unconfirmed_CP_IC_control)

Name <- c("Overall ORR",
          "Complete response (CR)",
          "Partial response (PR)",
          "Stable disease (SD)",
          "Progressive disease (PD)",
          "Non evaluable (NE)",
          "Clinical Benefit Rate (CBR)")

N_unconfirmed_control <- c(Overall_ORR_unconfirmed_control,
                   CR_unconfirmed_control,
                   PR_unconfirmed_control,
                   SD_unconfirmed_control,
                   PD_unconfirmed_control,
                   NE_unconfirmed_control,
                   CBR_unconfirmed_control)

Percentage_unconfirmed_control <- c(round(Overall_ORR_unconfirmed_control/total_control*100,1),
                            round(CR_unconfirmed_control/total_control*100,1),
                            round(PR_unconfirmed_control/total_control*100,1),
                            round(SD_unconfirmed_control/total_control*100,1),
                            round(PD_unconfirmed_control/total_control*100,1),
                            round(NE_unconfirmed_control/total_control*100,1),
                            round(CBR_unconfirmed_control/total_control*100,1))

#Puis on gere le brass traitement:

total_treatment <- length(unique(treatment$subjid))
CR_unconfirmed_treatment <- length(treatment$rcresp[treatment$rcresp == "Complete response"])
PR_unconfirmed_treatment <- length(treatment$rcresp[treatment$rcresp == "Partial response"])
SD_unconfirmed_treatment <- length(treatment$rcresp[treatment$rcresp == "Stable disease"])
PD_unconfirmed_treatment <- length(treatment$rcresp[treatment$rcresp == "Progressive disease"])
NE_unconfirmed_treatment <- length(treatment$rcresp[treatment$rcresp == "Not evaluable"])
Overall_ORR_unconfirmed_treatment <- CR_unconfirmed_treatment + PR_unconfirmed_treatment
CBR_unconfirmed_treatment <- length(treatment$CBR_2[treatment$CBR_2==1])

CR_unconfirmed_CP_treatment <- clopper.pearson.ci(CR_unconfirmed_treatment,total_treatment,CI="two.sided", alpha = 0.05)
PR_unconfirmed_CP_treatment <- clopper.pearson.ci(PR_unconfirmed_treatment,total_treatment,CI="two.sided", alpha = 0.05)
SD_unconfirmed_CP_treatment <- clopper.pearson.ci(SD_unconfirmed_treatment,total_treatment,CI="two.sided", alpha = 0.05)
PD_unconfirmed_CP_treatment <- clopper.pearson.ci(PD_unconfirmed_treatment,total_treatment,CI="two.sided", alpha = 0.05)
NE_unconfirmed_CP_treatment <- clopper.pearson.ci(NE_unconfirmed_treatment,total_treatment,CI="two.sided", alpha = 0.05)
Overall_ORR_unconfirmed_CP_treatment <- clopper.pearson.ci(Overall_ORR_unconfirmed_treatment,total_treatment,CI="two.sided", alpha = 0.05)
CBR_unconfirmed_CP_treatment <- clopper.pearson.ci(CBR_unconfirmed_treatment,total_treatment,CI="two.sided", alpha = 0.05)

CR_unconfirmed_CP_IC_treatment <- paste0("[",round(CR_unconfirmed_CP_treatment$Lower.limit*100,1),";",round(CR_unconfirmed_CP_treatment$Upper.limit*100,1),"]")
PR_unconfirmed_CP_IC_treatment <- paste0("[",round(PR_unconfirmed_CP_treatment$Lower.limit*100,1),";",round(PR_unconfirmed_CP_treatment$Upper.limit*100,1),"]")
SD_unconfirmed_CP_IC_treatment <- paste0("[",round(SD_unconfirmed_CP_treatment$Lower.limit*100,1),";",round(SD_unconfirmed_CP_treatment$Upper.limit*100,1),"]")
PD_unconfirmed_CP_IC_treatment <- paste0("[",round(PD_unconfirmed_CP_treatment$Lower.limit*100,1),";",round(PD_unconfirmed_CP_treatment$Upper.limit*100,1),"]")
NE_unconfirmed_CP_IC_treatment <- paste0("[",round(NE_unconfirmed_CP_treatment$Lower.limit*100,1),";",round(NE_unconfirmed_CP_treatment$Upper.limit*100,1),"]")
Overall_ORR_unconfirmed_CP_IC_treatment <- paste0("[",round(Overall_ORR_unconfirmed_CP_treatment$Lower.limit*100,1),";",round(Overall_ORR_unconfirmed_CP_treatment$Upper.limit*100,1),"]")
CBR_unconfirmed_CP_IC_treatment <- paste0("[",round(CBR_unconfirmed_CP_treatment$Lower.limit*100,1),";",round(CBR_unconfirmed_CP_treatment$Upper.limit*100,1),"]")

IC_95_unconfirmed_treatment <- c(Overall_ORR_unconfirmed_CP_IC_treatment,
                       CR_unconfirmed_CP_IC_treatment,
                       PR_unconfirmed_CP_IC_treatment,
                       SD_unconfirmed_CP_IC_treatment,
                       PD_unconfirmed_CP_IC_treatment,
                       NE_unconfirmed_CP_IC_treatment,
                       CBR_unconfirmed_CP_IC_treatment)

Name <- c("Overall ORR",
          "Complete response (CR)",
          "Partial response (PR)",
          "Stable disease (SD)",
          "Progressive disease (PD)",
          "Non evaluable (NE)",
          "Clinical Benefit Rate (CBR)")

N_unconfirmed_treatment <- c(Overall_ORR_unconfirmed_treatment,
                   CR_unconfirmed_treatment,
                   PR_unconfirmed_treatment,
                   SD_unconfirmed_treatment,
                   PD_unconfirmed_treatment,
                   NE_unconfirmed_treatment,
                   CBR_unconfirmed_treatment)

Percentage_unconfirmed_treatment <- c(round(Overall_ORR_unconfirmed_treatment/total_treatment*100,1),
                            round(CR_unconfirmed_treatment/total_treatment*100,1),
                            round(PR_unconfirmed_treatment/total_treatment*100,1),
                            round(SD_unconfirmed_treatment/total_treatment*100,1),
                            round(PD_unconfirmed_treatment/total_treatment*100,1),
                            round(NE_unconfirmed_treatment/total_treatment*100,1),
                            round(CBR_unconfirmed_treatment/total_treatment*100,1))


unconfirmed_Best_Response_during_treatment_2_arms <- as.data.frame(cbind(Name,
                                                                         N_unconfirmed_control,
                                                                         Percentage_unconfirmed_control,
                                                                         IC_95_unconfirmed_control,
                                                                         N_unconfirmed_treatment,
                                                                         Percentage_unconfirmed_treatment,
                                                                         IC_95_unconfirmed_treatment))
colnames(unconfirmed_Best_Response_during_treatment_2_arms) <- c("Unconfirmed Best Response during treatmen",
                                                                 paste0("Control_N=",total_control),
                                                                 "Control_%",
                                                                 "Control_IC 95%",
                                                                 paste0("Treatment_N=",total_treatment),
                                                                 "Treatment_%",
                                                                 "Treatment_IC 95%")
unconfirmed_Best_Response_during_treatment_2_arms =  unconfirmed_Best_Response_during_treatment_2_arms %>%
  as_flextable(show_coltype = F, include.row_percent = FALSE, include.column_percent = FALSE, include.table_percent = FALSE) %>%
  delete_rows(i=1, part = "footer") %>%
  separate_header() %>% 
  align(align = "center", part = "header") %>%
  align(align = "center", part = "body") %>%
  bold(bold = TRUE, part = "header") %>%
  bold(i = c(1,7), j = 1, bold = TRUE, part = "body") %>%
  surround(i = c(1,6), j = 1:7, border.bottom = fp_border(color = "black", style = "solid", width = 1), part = "body")  %>%
  footnote( i = 2, j = c(4,7),
            value = as_paragraph(
              c("Clopper-Pearson (Exact) method was used for confidence interval")),
            ref_symbols ="*", part = "header") %>%
  valign(valign = "bottom", part = "header") %>%
  footnote( i = c(6,7), j = 1,
            value = as_paragraph(
              c("Example : Patient 129 had NE as her global response for target lesion was NE.",
                "CBR was defined as the presence of at least a partial response (PR), complete response (CR), or stable disease (SD) lasting at least six months (using a window of +/-1 month for the RECIST date).")),
            ref_symbols = c("1", "2"), part = "body") %>%
  valign(valign = "bottom", part = "header") %>%
  vline(j = c(1,4), border = fp_border(color = "black", style = "solid", width = 2)) %>%
  autofit()
unconfirmed_Best_Response_during_treatment_2_arms
```

