---
title: "Kaplan Meier instruction suggestion"
author: "Livia Pierotti"
date: "2024-11-26"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include=FALSE, warning=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)

library(tidyverse)
t0 = ISOdate(2020, 01, 01, tz="EST")
data_surv = ggsurvfit::df_colon %>% 
  mutate(
    date_enrol = t0 + abs(rnorm(n(), 100, 10)), 
    date_eos = date_enrol + time,
    death_eos = status,
    date_progression = date_enrol + time*runif(n(), 0.6, 0.8),
    date_progression = if_else(runif(n())>0.2, NA, date_progression), 
  ) %>% 
  select(subijd=id, arm=rx, surg, 
         date_enrol, date_progression, date_eos, death_eos)
#data_surv est caché (include=FALSE), il suffit donc de présenter le dataset et ses colonnes (comme tu le ferais avec df_colon), puis d'expliquer comment utiliser pmin() pour créer time_os, event_os, time_pfs, event_pfs
```

```{r setup}
library(grstat)
library(tidyverse)
library(survival)
library(ggsurvfit)
```

# 1. Variable Creation

First, the variables time and status (indicating whether an event occurred or was censored) need to be created to enable the use of various functions.


* Time variable:

The time variable represents the duration from a defined starting point (e.g., diagnosis, study enrollment, or start of treatment) to the time at which the patient's status is recorded. It is a numeric variable measured in units such as days, months, or years, depending on the study's duration and requirements.

* Status variable:

The status variable is binary, indicating whether the event has occurred (event = 1) or not (censored = 0) for each subject by the end of the study period.

An event (1) indicates that the subjects experienced the event of interest (e.g., death, relapse, transplant failure, etc.).

Censored (0) refers to those subjects who did not experience the event during the study. For these individuals, the 'time-to-event' is considered censored, indicating that we only know they did not experience the event up to a certain point.

### Example

```{r}
data <- data.frame(
  id = 1:5,
  date_of_death = as.Date(c('2023-05-01', '2023-07-15', NA, '2023-09-10', '2023-06-20')),
  date_of_relapse = as.Date(c('2023-04-10', NA, '2023-06-01', '2023-08-01', NA)),
  date_of_last_visit = as.Date(c('2023-04-15', '2023-06-28', '2023-06-10', '2023-08-01', '2023-06-15')),
  date_first_visit = as.Date(c('2023-01-15', '2023-05-20', '2023-03-01', '2023-07-05', '2023-02-10')),
  # Event column: 1 for death or relapse, 0 for no event
  event = c(1, 0, 1, 1, 0)
)

# Print the data frame
print(data)


ds=data %>%
  mutate(status= ifelse(event=="death", 1, 0 )) %>%
  mutate(status_date = case_when(
    status == 1  ~ pmin(date_of_relapse,date_of_death, na.rm = T), 
    status == 0  ~ pmax(date_of_last_visit,na.rm = T)
  )) %>% 
  mutate(time_days=status_date-date_first_visit ) %>%  
  mutate(time_years=time_days/365.25 )  

print(ds)
```

# 2.Generate the summary of the survival

We recommend using the survival package with the survfit2 function instead of survfit function.


```{r}
km.model_PFS <- survfit2(Surv(time, status) ~ surg,data = df_colon)
print(km.model_PFS)
summary(km.model_PFS)

```


# 3.Generate survival curves using ggsurvfit package


Please follow the following link to obtain your kaplan Meier Curves
https://www.danieldsjoberg.com/ggsurvfit/articles/gallery.html

Kaplan-Meier by Daniel D. Sjoberg, Mark Baillie, Charlotta Fruechtenicht, Steven Haesendonckx, Tim Treis.


```{r}

km = survfit2(Surv(time, status) ~ surg, data = df_colon) %>%
  ggsurvfit(linetype_aes = TRUE) +
  add_confidence_interval() +
  add_risktable(
    risktable_stats = c("n.risk", "cum.censor", "cum.event")
  ) +
  theme_ggsurvfit_KMunicate() +
  scale_y_continuous(limits = c(0, 1)) +
  scale_x_continuous(expand = c(0.02, 0)) +
  theme(legend.position.inside = c(0.85, 0.85))

km
```



### Extra codes to make the plot better

```{r}
km +
  add_censor_mark(size = 4, alpha = 0.4) +
  scale_x_continuous(breaks = scales::breaks_width(2), limits=c(0, 10)) +
  scale_y_continuous(labels=scales::label_percent(), limits=c(0,1)) +
  labs(
    x = "Time from begining of treatment to progression or death (months)",
    y = "Progression Free Survival",
    title="Progression Free Survival, (N=X, n event=X)"
  ) +
  theme(legend.position = "top")

```



