---
title: "Adverse Events (AE)"
output: 
  rmarkdown::html_vignette:
    number_sections: true
vignette: >
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
date: "2025-01-30"
---

<!-- https://oncostat.github.io/grstat/articles/adverse_events_sas.html -->

# Introduction

This tutorial demonstrates how to generate adverse event (AE) summary tables in R using the `grstat` package. AE tables are a standard tool in clinical research for evaluating the severity (grade) of events and identifying specific AE terms.

In this tutorial, it is demonstrated how to use two key functions:

-   'ae_table_grade', which creates table(s) summarising AE grades.

-   'ae_table_soc', which summarises adverse events by System Organ Class (SOC) according to CTCAE terminology. It reports the number and proportion of patients experiencing at least one event within each SOC, based on their maximum recorded AE grade.

These tables can be generated for single-arm and more than one arm clinical trials.

First, install packages if needed and load them.

```{r setup, message=FALSE, warning=FALSE}
library(grstat)
library(flextable)
library(dplyr)
```

# Data Overview

The function `grstat_example()` is used as an example dataset to illustrate the data usage.

This analysis focuses on two datasets:

-   ae, which contains data on adverse events.

-   enrolres, which includes all patients and their respective treatment arms."

```{r}

tm = grstat_example()
attach(tm)

head(ae)

head(enrolres)

```

# Grade Tables: 'ae_table_grade'

Create adverse event (AE) grade tables using '`ae_table_grade()'`.

By default, the function `ae_table_grade` produces three table variants within a single output.

-   The most common variant is **`variant = "max"`**, which generates the table of maximum AE grade per patient. In this case, the percentages reflect the proportion of patients whose maximum AE grade was as indicated.

-   The second variant, **`variant = "sup"`**, summarises the maximum grade greater than or equal to a specified grade per patient. Here, the percentages reflect the proportion of patients whose maximum AE grade was superior or equal to the indicated grade.

-   The third variant, **`variant = "eq"`**, presents all grades for all patients. In this table, each proportion represents the number of patients who experienced a given grade at least once, i.e. the percentages reflect the proportion of patients who experienced the indicated AE grade at least once.

## Table of AE grade

```{r}
ae_table_grade(df_ae=ae, df_enrol=enrolres, arm=NULL) %>% 
  as_flextable(header_show_n=TRUE) %>%
  fontsize(size = 8, part = "all")
```

As an extra example of AE grade table, a table of maximum grade per patient and per arm (i.e. variant = "max") is also presented.

## Table of maximum AE grade per patient per arm

```{r}
ae_table_grade(df_ae=ae, df_enrol=enrolres, arm="arm", variant="max") %>% 
  as_flextable(header_show_n=TRUE) %>% 
  add_footer_lines("Percentages reflect the proportion of patients whose maximum AE grade was as indicated per given arm.")
```

# SOC's tables; ae_table_soc

There are two tables that we can created, one with only the SOC an also another one with the AE terms.

```{r}
ae_table_soc(df_ae=ae, df_enrol=enrolres, arm=NULL, term=NULL, 
             sort_by_count=FALSE) %>% 
  as_flextable() %>% 
  add_footer_lines("In the header, N represents the number of patients.") %>% 
  add_footer_lines("Percentages reflect the proportion of patients whose maximum AE grade was as indicated.")
```
